<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë‘ë“œë¦¬ê¸° ì±Œë¦°ì§€</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background-color: #111;
        color: #fff;
        text-align: center;
        user-select: none;
      }
      h1 {
        margin-top: 20px;
      }
      #game-area {
        position: relative;
        height: 70vh;
        background-color: #222;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 3px dashed #444;
        margin: 20px;
        border-radius: 10px;
        overflow: hidden;
      }
      #tap-image {
        width: 90%;
        max-width: 600px;
        border-radius: 15px;
      }
      #touch-guide {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2rem;
        color: rgba(255, 255, 255, 0.85);
        background: rgba(0, 0, 0, 0.4);
        padding: 10px 20px;
        border-radius: 10px;
        z-index: 2;
        pointer-events: none;
      }
      button,
      input {
        padding: 12px 20px;
        font-size: 1rem;
        margin: 5px;
        border-radius: 10px;
        border: none;
      }
      #start-btn {
        background-color: #4caf50;
        color: white;
      }
      #score-board {
        margin-top: 20px;
      }
      #record-list {
        margin-top: 20px;
        text-align: left;
        max-width: 400px;
        margin-inline: auto;
      }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  </head>
  <body>
    <h1>ì¿¨ì½” ìŠ¤ë‚´ì¹˜ ê²Œì„ğŸ”¥</h1>

    <div>
      ë‹‰ë„¤ì„: <input type="text" id="nickname" placeholder="ì´ë¦„ ì…ë ¥" />
      <button id="start-btn">ê²Œì„ ì‹œì‘</button>
    </div>

    <div id="game-area">
      <div id="touch-guide">í„°ì¹˜í•˜ì„¸ìš”!</div>
      <img id="tap-image" src="image1.png" alt="ê²Œì„ ì´ë¯¸ì§€" />
    </div>

    <div id="score-board">
      ì ìˆ˜: <span id="score">0</span> / ë‚¨ì€ ì‹œê°„: <span id="time">0</span>s
    </div>

    <h2>ğŸ“Š ì „ì²´ ë­í‚¹</h2>
    <ul id="record-list"></ul>

    <script>
      // âœ… Firebase ì„¤ì •
      const firebaseConfig = {
        apiKey: 'AIzaSyAXH9xjHMplAFY2V4UIJD3aLa7RSva4DyY',
        authDomain: 'minigame-3f3fe.firebaseapp.com',
        databaseURL:
          'https://minigame-3f3fe-default-rtdb.asia-southeast1.firebasedatabase.app',
        projectId: 'minigame-3f3fe',
        storageBucket: 'minigame-3f3fe.firebasestorage.app',
        messagingSenderId: '301246638499',
        appId: '1:301246638499:web:694751257945fca9ff5216',
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // HTML ìš”ì†Œ
      const startBtn = document.getElementById('start-btn');
      const nicknameInput = document.getElementById('nickname');
      const tapImage = document.getElementById('tap-image');
      const scoreDisplay = document.getElementById('score');
      const timeDisplay = document.getElementById('time');
      const touchGuide = document.getElementById('touch-guide');
      const recordList = document.getElementById('record-list');

      const imgList = ['image1.png', 'image2.png', 'image3.png'];
      let currentImgIndex = 0;
      let score = 0;
      let totalTime = 10;
      let remainingTime = 10;
      let timer;
      let playing = false;
      let lastClickTime = 0;

      function startGame() {
        const nickname = nicknameInput.value.trim();
        if (!nickname) return alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

        score = 0;
        remainingTime = totalTime;
        currentImgIndex = 0;
        lastClickTime = 0;
        playing = true;

        tapImage.src = imgList[currentImgIndex];
        scoreDisplay.textContent = score;
        timeDisplay.textContent = remainingTime;
        touchGuide.style.display = 'block';

        timer = setInterval(() => {
          remainingTime--;
          timeDisplay.textContent = remainingTime;
          if (remainingTime <= 0) {
            clearInterval(timer);
            playing = false;
            touchGuide.style.display = 'none';
            console.log('ğŸ”¥ ê²Œì„ ì¢…ë£Œ. ì €ì¥ ì‹œë„:', nickname, score);
            saveRecordToFirebase(nickname, score);
            alert(`ê²Œì„ ì¢…ë£Œ! ${nickname}ë‹˜ì˜ ì ìˆ˜: ${score}`);
          }
        }, 1000);
      }

      function handleTap() {
        if (!playing) return;
        const now = Date.now();
        if (now - lastClickTime < 100) return;
        lastClickTime = now;

        score++;
        scoreDisplay.textContent = score;
        currentImgIndex = (currentImgIndex + 1) % imgList.length;
        tapImage.src = imgList[currentImgIndex];
      }

      function saveRecordToFirebase(name, score) {
        const newRef = db.ref('records').push();
        newRef
          .set({ name, score, timestamp: Date.now() })
          .then(() => {
            console.log('âœ… ì €ì¥ ì™„ë£Œ, ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤í–‰');
            loadRecordsFromFirebase();
          })
          .catch((err) => {
            console.error('âŒ ì €ì¥ ì‹¤íŒ¨:', err);
          });
      }

      function loadRecordsFromFirebase() {
        console.log('ğŸ“¥ ë­í‚¹ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        db.ref('records')
          .orderByChild('score')
          .limitToLast(10)
          .once('value')
          .then((snapshot) => {
            const records = [];
            snapshot.forEach((child) => records.push(child.val()));
            records.sort((a, b) => b.score - a.score);
            console.log('âœ… ë­í‚¹ ê²°ê³¼:', records);
            displayRecords(records);
          })
          .catch((err) => {
            console.error('âŒ ë­í‚¹ ë¡œë”© ì‹¤íŒ¨:', err);
          });
      }

      function displayRecords(records) {
        recordList.innerHTML = '';
        if (!records || records.length === 0) {
          const li = document.createElement('li');
          li.textContent = 'ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.';
          recordList.appendChild(li);
          return;
        }

        records.forEach((r, i) => {
          const date = new Date(r.timestamp).toLocaleString();
          const li = document.createElement('li');
          li.textContent = `${i + 1}ìœ„ - ${r.name} : ${r.score}íšŒ (${date})`;
          recordList.appendChild(li);
        });
      }

      // ì´ë²¤íŠ¸
      startBtn.addEventListener('click', startGame);
      tapImage.addEventListener('click', handleTap);
      tapImage.addEventListener('touchstart', handleTap);

      // ğŸ”¥ í˜ì´ì§€ ë¡œë“œì‹œ ë°”ë¡œ ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸°
      document.addEventListener('DOMContentLoaded', () => {
        console.log('ğŸŒ í˜ì´ì§€ ë¡œë”©ë¨ â†’ ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤í–‰');
        loadRecordsFromFirebase();
      });
    </script>
  </body>
</html>
